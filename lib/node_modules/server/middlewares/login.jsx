import axios from 'axios';

function login(req, res) {
  axios({
    method: 'post',
    baseURL: process.env.API__URL,
    url: '/authenticate',
    data: req.body,
  })
  .then((apiRes) => {
    if (apiRes.data.status === 'fail') {
      const message = apiRes.data.meta.message;
      const errors = JSON.stringify(apiRes.data.meta.validation.errors);
      const values = JSON.stringify(apiRes.data.meta.validation.values);
      return res.redirect(
        `/login?message=${message}`
        + `&errors=${encodeURIComponent(errors)}`
        + `&values=${encodeURIComponent(values)}`);
    }

    if (apiRes.data.status === 'error') {
      return res.redirect(`/login?message=${apiRes.data.meta.message}`);
    }

    res.cookie('token', apiRes.data.data.token, {
      expires: new Date(apiRes.data.data.expires),
      httpOnly: true,
    });

    return res.redirect('/dashboard');
  })
  .catch(() => res.redirect('/login'));
}

export default login;
